# Github Workflows and the Syntropy Stack

We can use Github Actions and Workflows to automate the deployment and configuration of Syntropy Endpoints and Networks when pushing or merging commits.

In order to achieve this, the workflow's execution environment inside the runner (ie. Docker container) needs to have SSH access to the host VMs. Before the jobs that are defined in the workflows can succeed, we need to configure both our VMs and the repo itsef.

## Generate a new SSH key-pair

We'll create a new SSH keypair that we'll use exclusively for the Github Actions as you should not be using you primary key-pair. Call the new key-pair something like `github_action_rsa` to make it easy to identify. The `-N` flag creates a keypair without a passphrase.

```
ssh-keygen -t rsa -b 4096 -C "user@host" -q -N ""
```

## Authorize your new key on your VMs

Add your new public key to each of your hosts `authorized_keys`.

Eg.

```
ssh-copy-id -i ~/.ssh/github_action_rsa.pub <user>@<host> -f
```

You can also do this manually if you don't have `ssh-copy-id` available. Just SSH into your VM and add the public key to the `~/.ssh/authorized_keys` file.

## Add VMs from your known_hosts as a repository secret

You'll need to add each of your hosts public keys to a known_hosts repository secret. The simplest way to do this is to read and copy them from your local `known_hosts` file. It's important to note that you should have accessed each of your VMs via SSH at least once to ensure they're present in your `known_hosts` file.

```
cat `/.ssh/known_hosts`
```

Identify your VMs by their host IP. Eg:

```
54.x.x.x ecdsa-sha2-nistp256 AAAAE2...xPM=
```

Make sure you have all three selected, copy them and paste them into a new repository secret called `SSH_KNOWN_HOSTS`.

## Add your github actions private key as a repository secret

Your workflow runner will require a private key in order to gain SSH access to the VMs. We do this by adding the key to the filesystem from the secrets. Copy the contents of your new private key to the clipboard.

Eg.

```
pbcopy < ~/.ssh/github_action_rsa
```

And paste it in a new repository secret called `SSH_PRIVATE_KEY`.

## Add the outstanding repository secrets required by your workflow

Here's a list of the current secrets that are required:

- `SYNTROPY_API_TOKEN`: Api Token generated by the `syntropyctl login` cmd
- `SYNTROPY_API_KEY`: Agent Token generated via Syntropy UI
- `SYNTROPY_USERNAME`: Your Syntropy Stack username
- `SYNTROPY_PASSWORD`: Your Syntropy Stack password
- `SSH_PRIVATE_KEY`: Contents of your newly generated private key
- `SSH_KNOWN_HOSTS`: List of public keys for your VMs

Each workflow may require additional secrets.

# Additional Repository Secrets for MQTT examples

- `BROKER_HOST`: Public IP address of the Broker
- `BROKER_USER`: SSH User for the Broker host
- `PUBLISHER_HOST`: Public IP address of the Publisher
- `PUBLISHER_USER`: SSH User for the Publisher host
- `SUBSCRIBER_HOST`: Public IP address of the Subscriber
- `SUBSCRIBER_USER`: SSH User for the Subscriber host
